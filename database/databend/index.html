<!doctype html>
<html lang="en">

<head>
        <title>databend - nixianjun6</title>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        
        
        

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="../../assets/css/bootstrap.min.css">
        <link rel="stylesheet" href="../../assets/css/dracula-ui.css">
        <link rel="stylesheet" href="../../assets/css/mkdocs.css">

        
            <link  rel="icon" type="image/x-icon" href="../../img/favicon.ico">
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
                <script>hljs.initHighlightingOnLoad();</script>

</head>

<body class="drac-bg-black-secondary drac-text-grey-ternary drac-text drac-scrollbar-purple">

    <main class="d-flex">

        <!-- block sidebar -->
            <nav id="sidebar" class="sidebar drac-bg-black">
    <div class="custom-menu">
        <button type="button" id="sidebarCollapse" class="btn btn-primary">
            <i class="fa fa-bars"></i>
            <span class="sr-only">Menu</span>
        </button>
    </div>

    <div class="p-4">
        
            <img class="logo" src="../../img/nixianjun.png" height="150px">
        

        <div class="drac-text-center">
            
                <span class="drac-text drac-line-height drac-text-white">nixianjun6</span>
            
        </div>

        <div class="drac-box flex-column">
            <ul class="dot-ul">
                <li><div class="dot-li drac-bg-cyan"></div></li>
                <li><div class="dot-li drac-bg-green"></div></li>
                <li><div class="dot-li drac-bg-orange"></div></li>
                <li><div class="dot-li drac-bg-pink"></div></li>
                <li><div class="dot-li drac-bg-purple"></div></li>
                <li><div class="dot-li drac-bg-red"></div></li>
                <li><div class="dot-li drac-bg-yellow"></div></li>
            </ul>
        </div>

        <hr class="drac-divider" />

        <!-- block menu -->
        <ul class="mb-5 drac-list drac-list-none">
            
            <li class="drac-box">
                <a href="../.."
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Home
                </a>
            </li>
            <li class="drac-box">
                <a href="../.."
                    class=" active 
                    drac-anchor btn-toggle d-inline-flex align-items-center border-0 drac-text-purple--hover collapsed"
                    data-bs-toggle="collapse" data-bs-target="#database-collapse" aria-expanded="false">
                    Database
                </a>
                <div class="collapse" id="database-collapse">
                    <ul class="mb-5 drac-list drac-list-none">
                            
    <li class="drac-box-ternary">
        <a href="../cmu15445/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            cmu15445
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../leveldb/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            leveldb
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../cmu15721/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            cmu15721
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="./"
            class=" active 
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            databend
        </a>
    </li>
                    </ul>
                </div>
            </li>
            <li class="drac-box">
                <a href="../.."
                    class="
                    drac-anchor btn-toggle d-inline-flex align-items-center border-0 drac-text-purple--hover collapsed"
                    data-bs-toggle="collapse" data-bs-target="#distributed-system-collapse" aria-expanded="false">
                    Distributed System
                </a>
                <div class="collapse" id="distributed-system-collapse">
                    <ul class="mb-5 drac-list drac-list-none">
                            
    <li class="drac-box-ternary">
        <a href="../../distributed%20system/mit6.824/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            mit6.824
        </a>
    </li>
                    </ul>
                </div>
            </li>
        </ul>
        <!-- endblock -->
    </div>
</nav>
        <!-- endblock -->

        <nav class="divider drac-bg-purple-cyan"></nav>

        <div class="content">
            <!-- block header -->
                <header>
    <nav class="navbar navbar-expand-xl drac-bg-purple"">
        <div class="container-fluid">

            <!-- <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsMenu"
                aria-controls="navbarsMenu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button> -->

            <div class="collapse navbar-collapse flex-column ml-auto" id="navbarsMenu">
                <ul class="navbar-nav">

                    <!-- block preview -->
                    <li class="nav-item">
                            
        <div class="container">
            <div class="row row-preview">
                <div class="col">
                    <a href="../cmu15721/"
                        class="btn-preview drac-btn drac-btn-outline drac-text-white drac-text-cyan-green--hover">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </div>
                <div class="col">
                    <a href="../../distributed%20system/mit6.824/"
                        class="btn-preview drac-btn drac-btn-outline drac-text-white drac-text-cyan-green--hover" style="padding-left: 3%;">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
                    </li>
                    <!--  endblock -->

                    <!-- block search -->
                    <li class="nav-item"><div role="search" class="search-box">
	<form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
		<input type="text" name="q" class="drac-input drac-input-search drac-input-white drac-text-white drac-bg-black-secondary"
		placeholder="Search docs" title="Type search term here" />
	</form>
</div>
                    </li>
                    <!--  endblock -->

                    <!-- block source -->
                    <li class="nav-item">
                        
                    </li>
                    <!--  endblock -->

                </ul>
            </div>

        </div>
    </nav>
</header>
            <!-- endblock -->

            <!-- block content -->
                <section class="p-md-5 section-content">
    <article>
        <p><h1 id="databend">Databend</h1>
<h2 id="common">common</h2>
<h3 id="datavalues">datavalues</h3>
<p>对列向量进行抽象。</p>
<ul>
<li>DataSchema为arrow::datatypes::Schema, DataSchemaRef为arrow::datatypes::SchemaRef,</li>
<li>DataType用的是arrow::datatypes::DataType。实现了数字类型变量的强制转换。</li>
<li>DataField为arrow::datatypes::Field</li>
<li>DataArray: 向量。DataArrayRef为arrow::array::ArrayRef。</li>
<li>DataValue: 标量。 能与DataArray, rust标准类型，DataType相互转换。实现了算术运算与聚合运算。</li>
<li>DataColumnarValue:实现了二元的And与Or的逻辑运算，比较运算，算术运算，聚合运算，merge sort。（如果操作对象是标量则转换为向量）</li>
</ul>
<pre><code class="language-rust">#[derive(Clone, Debug)]
pub enum DataColumnarValue {
    // Array of values.
    Array(DataArrayRef),
    // A Single value.
    Scalar(DataValue),
}
</code></pre>
<h3 id="datablocks">datablocks:</h3>
<p>对多行列向量进行抽象。</p>
<ul>
<li>能与arrow::record_batch::RecordBatch相互转换。</li>
<li>通过block_take_by_indices方法按行取索引值, 通过concat_blocks进行拼接操作，sort_block对单个block进行排序，merge_sort_block对两个已排序blocks进行merge，merge_sort_blocks递归对多个排序blocks merge。</li>
</ul>
<pre><code class="language-rust">#[derive(Debug, Clone)]
pub struct DataBlock {
    schema: DataSchemaRef,
    columns: Vec&lt;DataArrayRef&gt;,
}
</code></pre>
<h3 id="planners">planners:</h3>
<p>主要用于生成逻辑查询计划。</p>
<ul>
<li>plan partition: 对查询计划进行分区。</li>
<li>plan statistics: 查询计划统计量</li>
<li>plan_rewriter: 对表达式中的别名进行重写</li>
<li>plan walker: 查询计划遍历</li>
</ul>
<pre><code class="language-rust">#[derive(Clone)]
pub enum PlanNode {
    Empty(EmptyPlan),
    Stage(StagePlan),
    Projection(ProjectionPlan),
    AggregatorPartial(AggregatorPartialPlan),
    AggregatorFinal(AggregatorFinalPlan),
    Filter(FilterPlan),
    Sort(SortPlan),
    Limit(LimitPlan),
    Scan(ScanPlan),
    ReadSource(ReadDataSourcePlan),
    Select(SelectPlan),
    Explain(ExplainPlan),
    CreateTable(CreateTablePlan),
    CreateDatabase(CreateDatabasePlan),
    SetVariable(SettingPlan),
}

#[derive(Clone)]
pub enum ExpressionPlan {
    /// An expression with a alias name.
    Alias(String, Box&lt;ExpressionPlan&gt;),
    /// Column name.
    Column(String),
    /// Constant value.
    Literal(DataValue),
    /// A binary expression such as &quot;age &gt; 40&quot;
    BinaryExpression {
        left: Box&lt;ExpressionPlan&gt;,
        op: String,
        right: Box&lt;ExpressionPlan&gt;,
    },
    /// Functions with a set of arguments.
    Function {
        op: String,
        args: Vec&lt;ExpressionPlan&gt;,
    },
    /// A sort expression, that can be used to sort values.
    Sort {
        /// The expression to sort on
        expr: Box&lt;ExpressionPlan&gt;,
        /// The direction of the sort
        asc: bool,
        /// Whether to put Nulls before all other data values
        nulls_first: bool,
    },
    /// All fields(*) in a schema.
    Wildcard,
}
</code></pre>
<h3 id="functions">functions:</h3>
<p>主要用于对向量真正进行运算。</p>
<p>每个functions通过eval方法得到DataColumnarValue。其中聚合函数需要实现accumulate方法将结果存储在self.state中，merge方法会把同一深度的self.state进行聚合。</p>
<ul>
<li>FunctionFactory: 通过get方法产生算数，比较，逻辑，聚合以及UDF Function</li>
</ul>
<pre><code class="language-rust">pub trait IFunction: fmt::Display + Sync + Send + DynClone {
    fn return_type(&amp;self, input_schema: &amp;DataSchema) -&gt; FuseQueryResult&lt;DataType&gt;;
    fn nullable(&amp;self, input_schema: &amp;DataSchema) -&gt; FuseQueryResult&lt;bool&gt;;
    fn eval(&amp;self, block: &amp;DataBlock) -&gt; FuseQueryResult&lt;DataColumnarValue&gt;;
    fn set_depth(&amp;mut self, depth: usize);
    fn accumulate(&amp;mut self, block: &amp;DataBlock) -&gt; FuseQueryResult&lt;()&gt;;
    fn accumulate_result(&amp;self) -&gt; FuseQueryResult&lt;Vec&lt;DataValue&gt;&gt;;
    fn merge(&amp;mut self, states: &amp;[DataValue]) -&gt; FuseQueryResult&lt;()&gt;;
    fn merge_result(&amp;self) -&gt; FuseQueryResult&lt;DataValue&gt;;
    fn is_aggregator(&amp;self) -&gt; bool {
        false
    }
}
</code></pre>
<h3 id="streams">streams:</h3>
<p>数据块迭代异步执行。</p>
<pre><code class="language-rust">pub type SendableDataBlockStream = std::pin::Pin&lt;
    Box&lt;dyn futures::stream::Stream&lt;Item = FuseQueryResult&lt;DataBlock&gt;&gt; + Sync + Send&gt;,
&gt;;
</code></pre>
<h3 id="infallible">infallible:</h3>
<p>​   互斥锁和读写锁的封装</p>
<p>runtime:</p>
<p>​   tokio异步运行时</p>
<hr />
<h2 id="metasrv">metasrv</h2>
<h3 id="api">api:</h3>
<p>​   实现了rpc与http的通信服务</p>
<h3 id="configs">configs:</h3>
<p>主要用于加载选项设置。</p>
<pre><code class="language-rust">#[derive(Debug, StructOpt, Clone)]
pub struct Config {
    #[structopt(env = &quot;FUSE_STORE_VERSION&quot;, default_value = &quot;Unknown&quot;)]
    pub version: String,

    #[structopt(long, env = &quot;FUSE_STORE_LOG_LEVEL&quot;, default_value = &quot;info&quot;)]
    pub log_level: String,

    #[structopt(
        long,
        env = &quot;FUSE_STORE_METRIC_API_ADDRESS&quot;,
        default_value = &quot;127.0.0.1:7171&quot;
    )]
    pub metric_api_address: String,

    #[structopt(
        long,
        env = &quot;FUSE_QUERY_RPC_API_ADDRESS&quot;,
        default_value = &quot;127.0.0.1:9191&quot;
    )]
    pub rpc_api_address: String,
}
</code></pre>
<h3 id="engine">engine:</h3>
<p>​   MemEngine is a prototype storage that is primarily used for testing purposes.</p>
<pre><code class="language-rust">pub struct MemEngine {
    pub dbs: HashMap&lt;String, Db&gt;,
    pub next_id: i64,
    pub next_ver: i64,
}
</code></pre>
<h3 id="executor">executor:</h3>
<p>​   存储服务的执行器。目前支持的服务包括:CreateDatabase, CreateTable和GetTable。</p>
<pre><code class="language-rust">pub struct ActionHandler {
    meta: Arc&lt;Mutex&lt;MemEngine&gt;&gt;,
}
</code></pre>
<h3 id="fs">fs:</h3>
<p>​   存储层提供调用的API。提供读写文件以及展示路径下文件的功能。</p>
<pre><code class="language-rust">#[async_trait]
pub trait IFileSystem {
    /// Add file atomically.
    /// AKA put_if_absent
    async fn add&lt;'a&gt;(
        &amp;'a self,
        path: impl AsRef&lt;Path&gt; + Send + 'a,
        data: &amp;[u8],
    ) -&gt; anyhow::Result&lt;()&gt;;

    /// read all bytes from a file
    async fn read_all&lt;'a&gt;(&amp;'a self, path: impl AsRef&lt;Path&gt; + Send + 'a) -&gt; anyhow::Result&lt;Vec&lt;u8&gt;&gt;;

    /// List dir and returns directories and files.
    async fn list&lt;'a&gt;(&amp;'a self, path: impl AsRef&lt;Path&gt; + Send + 'a) -&gt; anyhow::Result&lt;ListResult&gt;;
}
</code></pre>
<h3 id="data_part">data_part:</h3>
<p>​   </p>
<hr />
<h2 id="query">query</h2>
<h3 id="api_1">api:</h3>
<p>​   实现了http与rpc的通信服务。</p>
<h3 id="configs_1">configs:</h3>
<p>主要用于加载选项设置。</p>
<pre><code class="language-rust">#[derive(Debug, StructOpt, Clone)]
pub struct Config {
    #[structopt(env = &quot;FUSE_QUERY_VERSION&quot;, default_value = &quot;Unknown&quot;)]
    pub version: String,

    #[structopt(long, env = &quot;FUSE_QUERY_LOG_LEVEL&quot;, default_value = &quot;info&quot;)]
    pub log_level: String,

    #[structopt(long, env = &quot;FUSE_QUERY_NUM_CPUS&quot;, default_value = &quot;0&quot;)]
    pub num_cpus: u64,

    #[structopt(
        long,
        env = &quot;FUSE_QUERY_MYSQL_HANDLER_HOST&quot;,
        default_value = &quot;127.0.0.1&quot;
    )]
    pub mysql_handler_host: String,

    #[structopt(long, env = &quot;FUSE_QUERY_MYSQL_HANDLER_PORT&quot;, default_value = &quot;3307&quot;)]
    pub mysql_handler_port: u64,

    #[structopt(
        long,
        env = &quot;FUSE_QUERY_MYSQL_HANDLER_THREAD_NUM&quot;,
        default_value = &quot;256&quot;
    )]
    pub mysql_handler_thread_num: u64,

    #[structopt(
        long,
        env = &quot;FUSE_QUERY_CLICKHOUSE_HANDLER_HOST&quot;,
        default_value = &quot;127.0.0.1&quot;
    )]
    pub clickhouse_handler_host: String,

    #[structopt(
        long,
        env = &quot;FUSE_QUERY_CLICKHOUSE_HANDLER_PORT&quot;,
        default_value = &quot;9000&quot;
    )]
    pub clickhouse_handler_port: u64,

    #[structopt(
        long,
        env = &quot;FUSE_QUERY_CLICKHOUSE_HANDLER_THREAD_NUM&quot;,
        default_value = &quot;256&quot;
    )]
    pub clickhouse_handler_thread_num: u64,

    #[structopt(
        long,
        env = &quot;FUSE_QUERY_RPC_API_ADDRESS&quot;,
        default_value = &quot;127.0.0.1:9090&quot;
    )]
    pub rpc_api_address: String,

    #[structopt(
        long,
        env = &quot;FUSE_QUERY_HTTP_API_ADDRESS&quot;,
        default_value = &quot;127.0.0.1:8080&quot;
    )]
    pub http_api_address: String,

    #[structopt(
        long,
        env = &quot;FUSE_QUERY_METRIC_API_ADDRESS&quot;,
        default_value = &quot;127.0.0.1:7070&quot;
    )]
    pub metric_api_address: String,

    #[structopt(long, env = &quot;STORE_API_ADDRESS&quot;, default_value = &quot;127.0.0.1:9191&quot;)]
    pub store_api_address: String,

    #[structopt(long, env = &quot;STORE_API_USERNAME&quot;, default_value = &quot;root&quot;)]
    pub store_api_username: String,

    #[structopt(long, env = &quot;STORE_API_PASSWORD&quot;, default_value = &quot;root&quot;)]
    pub store_api_password: String,
}
</code></pre>
<h3 id="clusters">clusters:</h3>
<p>集群的抽象，记录了节点名字与节点相关信息的映射。</p>
<pre><code class="language-rust">#[derive(serde::Serialize, serde::Deserialize, Clone, Debug, PartialEq)]
pub struct Node {
    pub name: String,
    pub cpus: usize,
    pub priority: u8,
    pub address: String,
    pub local: bool,
}

pub struct Cluster {
    cfg: Config,
    nodes: Mutex&lt;HashMap&lt;String, Node&gt;&gt;,
}
</code></pre>
<h3 id="sessions">sessions:</h3>
<p>原来的contexts把options功能解耦。记录context uuid与context的映射关系。</p>
<ul>
<li>Settings: 设置某个变量的类型，支持的类型包括：u64, i6, f64和string。支持的操作包括：set(设置value, default value和description), update(更新value), get(获取value)</li>
<li>FuseQueryContext: 设置了max_threads, max_block_size, default_db的变量类型，value以及description。把原来的partition_queue从iTable中解耦到context中，并新增了uuid和cluster属性以支持分布式查询。</li>
</ul>
<pre><code class="language-rust">#[derive(Clone)]
pub struct FuseQueryContext {
    uuid: Arc&lt;RwLock&lt;String&gt;&gt;,
    settings: Settings,
    cluster: Arc&lt;RwLock&lt;ClusterRef&gt;&gt;,
    datasource: Arc&lt;dyn IDataSource&gt;,
    statistics: Arc&lt;RwLock&lt;Statistics&gt;&gt;,
    partition_queue: Arc&lt;RwLock&lt;VecDeque&lt;Partition&gt;&gt;&gt;,
}

pub struct Session {
    sessions: RwLock&lt;HashMap&lt;String, FuseQueryContextRef&gt;&gt;,
}
</code></pre>
<h3 id="servers">servers:</h3>
<ul>
<li>Session（与上一部分的Session不同，与上一版本的Session相同）: 目前实现了on_query，首先根据输入的sql语句与contexts通过build_from_sql方法生成查询计划。然后由InterpreterFactory根据查询计划与contexts生成物理查询计划executor。然后调用executor.execute()得到最后结果。并通过mysql stream发送给客户端。</li>
<li>MySQLHandler: 启动服务。</li>
<li>MySQLStream: 输出格式。</li>
</ul>
<pre><code class="language-rust">struct Session {
    ctx: FuseQueryContextRef,
}

pub struct MySQLHandler {
    conf: Config,
    cluster: ClusterRef,
    session_manager: SessionRef,
}

pub struct MySQLStream {
    blocks: Vec&lt;DataBlock&gt;,
}
</code></pre>
<h3 id="datasources">datasources:</h3>
<p>这一层抽象是为了更好实现不同类型文件的读取。</p>
<ul>
<li>DataSource:初始化时会注册system, local, default,  remote四个database。</li>
</ul>
<pre><code class="language-rust">#[async_trait::async_trait]
pub trait IDataSource: Sync + Send {
    fn get_database(&amp;self, db_name: &amp;str) -&gt; Result&lt;Arc&lt;dyn IDatabase&gt;&gt;;
    fn get_table(&amp;self, db_name: &amp;str, table_name: &amp;str) -&gt; Result&lt;Arc&lt;dyn ITable&gt;&gt;;
    fn get_all_tables(&amp;self) -&gt; Result&lt;Vec&lt;(String, Arc&lt;dyn ITable&gt;)&gt;&gt;;
    fn get_table_function(&amp;self, name: &amp;str) -&gt; Result&lt;Arc&lt;dyn ITableFunction&gt;&gt;;
    async fn create_database(&amp;self, plan: CreateDatabasePlan) -&gt; Result&lt;()&gt;;
}

pub struct DataSource {
    conf: Config,
    databases: RwLock&lt;HashMap&lt;String, Arc&lt;dyn IDatabase&gt;&gt;&gt;,
    table_functions: RwLock&lt;HashMap&lt;String, Arc&lt;dyn ITableFunction&gt;&gt;&gt;,
    store_client: RwLock&lt;Option&lt;StoreClient&gt;&gt;,
}

#[async_trait::async_trait]
pub trait IDatabase: Sync + Send {
    // Database name.
    fn name(&amp;self) -&gt; &amp;str;

    // Database engine.
    fn engine(&amp;self) -&gt; &amp;str;

    // Get one table by name.
    fn get_table(&amp;self, table_name: &amp;str) -&gt; Result&lt;Arc&lt;dyn ITable&gt;&gt;;

    // Get all tables.
    fn get_tables(&amp;self) -&gt; Result&lt;Vec&lt;Arc&lt;dyn ITable&gt;&gt;&gt;;

    // Get database table functions.
    fn get_table_functions(&amp;self) -&gt; Result&lt;Vec&lt;Arc&lt;dyn ITableFunction&gt;&gt;&gt;;

    // DDL
    async fn create_table(&amp;self, plan: CreateTablePlan) -&gt; Result&lt;()&gt;;
}

pub trait ITableFunction: Sync + Send + ITable {
    fn function_name(&amp;self) -&gt; &amp;str;
    fn db(&amp;self) -&gt; &amp;str;

    fn as_table&lt;'a&gt;(self: Arc&lt;Self&gt;) -&gt; Arc&lt;dyn ITable + 'a&gt;
    where
        Self: 'a;
}


#[async_trait::async_trait]
pub trait ITable: Sync + Send {
    fn name(&amp;self) -&gt; &amp;str;
    fn engine(&amp;self) -&gt; &amp;str;
    fn as_any(&amp;self) -&gt; &amp;dyn Any;
    fn schema(&amp;self) -&gt; Result&lt;DataSchemaRef&gt;;

    // Get the read source plan.
    fn read_plan(
        &amp;self,
        ctx: FuseQueryContextRef,
        push_down_plan: PlanNode,
    ) -&gt; Result&lt;ReadDataSourcePlan&gt;;

    // Read block datas from the underfling.
    async fn read(&amp;self, ctx: FuseQueryContextRef) -&gt; Result&lt;SendableDataBlockStream&gt;;
}
</code></pre>
<h3 id="sql">sql:</h3>
<ul>
<li>PlanParse: 从原来的planners中解耦出来。build_from_sql首先将sql语句转换为DFStatements(通过DFParser实现)。对于Statement::Query，按having -&gt; from-&gt; filter-&gt; projection -&gt; (aggr) -&gt; sort -&gt;  limit生成计划(主要通过PlanBuilder生成PlanNode)</li>
<li>在处理from时，会进一步调用table.read_plan生成ReadSource的PlanNode)。</li>
<li>在生成projection计划时，会先调用planRewrite来重写别名。</li>
<li>在生成aggr计划时，会生成aggregate_partial, stage(类似于mapreduce中的shuffle), aggregate_final三个计划。</li>
<li>对于表达式，通过sql_to_rex生成ExpressionPlan。</li>
</ul>
<pre><code class="language-rust">#[derive(Debug, Clone, PartialEq)]
pub enum DfStatement {
    /// ANSI SQL AST node
    Statement(SQLStatement),
    Explain(DfExplain),
    ShowTables(DfShowTables),
    ShowSettings(DfShowSettings),
    CreateDatabase(DfCreateDatabase),
    CreateTable(DfCreateTable),
}
</code></pre>
<h3 id="interpreters">interpreters:</h3>
<p>由于查询计划可能需要优化，而其他执行计划可能不需要，因此需要这样一层。</p>
<ul>
<li>InterpreterFactory: 将PlanNode转换为IInterpreter。对于SelectInterpreter来说，会首先调用Optimizer::create().optimize得到优化后的PlanNode。然后调用PipelineBuilder执行计划。</li>
</ul>
<pre><code class="language-rust">#[async_trait]
pub trait IInterpreter: Sync + Send {
    fn name(&amp;self) -&gt; &amp;str;
    async fn execute(&amp;self) -&gt; FuseQueryResult&lt;SendableDataBlockStream&gt;;
}
</code></pre>
<h3 id="optimizers">Optimizers:</h3>
<p>主要用于对逻辑查询计划的优化。</p>
<ul>
<li>Optimizer: 调用create添加需要应用的优化规则。再调用optimize按顺序优化查询计划。</li>
<li>filter_push_down: 完成了filter算子中的别名表达式替换。</li>
<li>limit_push_down: </li>
</ul>
<pre><code class="language-rust">pub trait IOptimizer {
    fn name(&amp;self) -&gt; &amp;str;
    fn optimize(&amp;mut self, plan: &amp;PlanNode) -&gt; FuseQueryResult&lt;PlanNode&gt;;
}

pub struct Optimizer {
    optimizers: Vec&lt;Box&lt;dyn IOptimizer&gt;&gt;,
}
</code></pre>
<h3 id="planners_1">planners:</h3>
<p>​   对Stage查询计划进行节点间的调度。</p>
<h3 id="pipelines">pipelines:</h3>
<p><strong>processors</strong>:</p>
<p>​   主要用于构建进程之间的执行顺序</p>
<ul>
<li>对于ReadSource的PlanNode, 会将输入进行分区，对于每个分区产生一个物理执行计划。</li>
<li>对于stage的PlanNode，会重构之前的Pipeline。按照planner中的调度方案产生RemoteTransform的物理查询计划，加入到pipeline中。</li>
<li>对于Sort的PlanNode,会产生SortPartialTransform对单个block进行排序，之后产生SortMergeTransform将blocks进行merge，最后调用merge_processor。</li>
<li>对于pipeline breaker的算子需要调用merge_processor等待某个节点前所有进程的完成。</li>
</ul>
<pre><code class="language-rust">#[async_trait]
pub trait IProcessor: Sync + Send {
    /// Processor name.
    fn name(&amp;self) -&gt; &amp;str;

    /// Connect to the input processor, add an edge on the DAG.
    fn connect_to(&amp;mut self, input: Arc&lt;dyn IProcessor&gt;) -&gt; FuseQueryResult&lt;()&gt;;

    /// Inputs.
    fn inputs(&amp;self) -&gt; Vec&lt;Arc&lt;dyn IProcessor&gt;&gt;;

    /// Reference used for downcast.
    fn as_any(&amp;self) -&gt; &amp;dyn Any;

    /// Execute the processor.
    async fn execute(&amp;self) -&gt; FuseQueryResult&lt;SendableDataBlockStream&gt;;
}

#[derive(Clone)]
pub struct Pipe {
    processors: Vec&lt;Arc&lt;dyn IProcessor&gt;&gt;,
}

pub struct Pipeline {
    processors: Vec&lt;Pipe&gt;,
}
</code></pre>
<p><strong>transforms:</strong></p>
<p>​   主要用于实现对每个DataBlock的物理查询计划执行。</p>
<ul>
<li>source: 调用table.read进行分区的读取。</li>
<li>remote: 通过rpc调用其他节点执行。</li>
<li>每个进程通过transforms实现executor方法，transforms会将表达式转换为functions，并实现expression_executor方法(对每个datablock执行functions的eval操作并生成新的DataBlock）。然后将functions和expression_executor方法传给datastream进行执行。</li>
</ul></p>
    </article>
</section>
            <!-- endblock -->

            <!-- block footer -->
                <footer>
    <div class="d-flex flex-sm-row justify-content-between py-2 border-top drac-text-black drac-bg-cyan-green">
        <a href="https://github.com/dracula/mkdocs" target="_blank" style="padding-left: 1%;"
            class="footer-text drac-anchor drac-text-black drac-text-purple--hover">
            Made with Dracula Theme for MkDocs
        </a>
    </div>
</footer>
            <!-- endblock -->
        </div>

    </main>

        <script>var base_url = '../..';</script>
        <script src="../../assets/js/jquery-3.3.1.slim.min.js""></script>
        <script src="../../assets/js/bootstrap.bundle.min.js""></script>
        <script src="../../assets/js/mkdocs.js""></script>
			<script src="../../search/main.js" defer></script>

</body>

</html>
